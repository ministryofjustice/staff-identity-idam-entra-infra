name: "[Workflow] PR"

on:
  pull_request:
    paths:
      - 'terraform/envs/devl/**'
      - 'terraform/envs/nle/**'
      - 'terraform/envs/live/**' 

defaults:
  run:
    shell: bash

permissions:
  id-token: write
  contents: write
  security-events: write
  pull-requests: write
  actions: none
  checks: none
  deployments: none
  issues: write
  packages: none
  repository-projects: none
  statuses: none

jobs:

  detect_changes:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - environment: devl
            path: terraform/envs/devl
          - environment: nle
            path: terraform/envs/nle
          - environment: live
            path: terraform/envs/live

            if: contains(github.event.pull_request.changed_files, matrix.path)
    
    outputs:
      environment: ${{ matrix.environment }}
      path: ${{ matrix.path }}

    steps:
      - name: output env and path
        run: echo ${{ matrix.environment }} ${{ matrix.path }}  
    
  validate_code:
    name: validate code
    uses: ./.github/workflows/validate_code.yml
    needs: detect_changes
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect_changes.outputs) }}
    with:
      environment_path: ${{ matrix.path }}

  terraform_plan_workflow:
    name: tf plan ${{ matrix.environment }}
    uses: ./.github/workflows/terraform_plan_job.yml
    needs: 
      - detect_changes
      - validate_code
    strategy:
      matrix:
        include: ${{ fromJson(needs.detect_changes.outputs) }}
    with:
      environment: ${{ matrix.environment}}
      environment_path: ${{ matrix.path }}
    secrets:
      arm_subscription_id: ${{ secrets.arm_subscription_id }}
      arm_tenant_id: ${{ secrets.arm_tenant_id }}
      arm_client_id: ${{ secrets.arm_client_id }}
      workspace_tenant_id: ${{ secrets.workspace_tenant_id }}
      workspace_client_id: ${{ secrets.workspace_client_id }}
      github_access_token: ${{ secrets.GITHUB_TOKEN }}
